<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT Media Antar Nusa (Nusanet) - Chat</title>
    <link rel="icon" type="image/x-icon" href="{{url_for('static', filename=('/img/image.png'))}}">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{url_for('static', filename=('/css/chat.css'))}}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="logo">
               <img src="{{url_for('static', filename=('/img/image.png'))}}" alt="Logo" width="60" height="48" class="d-inline-block align-text-top rounded-circle">
            </div>
            <div class="header-info">
                <h1 class="company-name">PT Media Antar Nusa (Nusanet)</h1>
                <div class="connection-status" id="connectionStatus">
                    <span class="connecting">Menghubungkan...</span>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-comment-dots"></i>
                <h3>Selamat datang!</h3>
                <p>Beritahu kami data yang anda butuhkan!</p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="input-container">
                <input 
                    type="text" 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Ketik pesan anda disini..."
                    autocomplete="off"
                >
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for displaying SQL Query -->
    <div id="sqlModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-code"></i> SQL Query</h3>
                <button class="close-btn" onclick="closeSqlModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="sqlModalBody">
                <!-- SQL content will be inserted here -->
            </div>
        </div>
    </div>

    <script >
        let messageCount = 0;
        var status = {{connection | tojson | safe}};
        if(status === "success") {
            connectionStatus.innerHTML = '<span class="connected"><i class="fas fa-circle"></i> Terhubung</span>';
        } else {
            connectionStatus.innerHTML = '<span class="disconnected"><i class="fas fa-circle"></i> Terputus</span>';
        }

        // Storage untuk SQL queries dari server - dinamis
        let sqlQueriesStorage = {};
        let chartInstances = {};
        let chartDataStorage = {};

        // Get current time in HH:MM format
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        // Show typing indicator
        function showTyping() {
            const chatArea = document.getElementById('chatArea');
            const emptyState = document.getElementById('emptyState');
            
            // Hide empty state if typing indicator is the first interaction
            if (messageCount === 0) {
                emptyState.style.display = 'none';
            }
            
            // Create typing indicator element
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'activeTyping';
            
            typingDiv.innerHTML = `
                <div class="typing-bubble">
                    <span class="typing-text">Nusafind sedang mengetik</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            setTimeout(() => {
                chatArea.appendChild(typingDiv);
                chatArea.scrollTop = chatArea.scrollHeight;
            }, 1000); // Trigger animation immediately 
        }

        // Hide typing indicator
        function hideTyping() {
            const activeTyping = document.getElementById('activeTyping');
            if (activeTyping) {
                activeTyping.remove();
            }
        }

        // Generate unique ID untuk setiap SQL query
        function generateSqlId() {
            return 'sql_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Store SQL query dari server
        function storeSqlQuery(sqlQuery) {
            if (!sqlQuery || sqlQuery.trim() === '') return null;
            
            const sqlId = generateSqlId();
            sqlQueriesStorage[sqlId] = {
                title: "PT Media Antar Nusa | Nusafind",
                description: "Query yang di generate berdasarkan pertanyaan kamu",
                sql: sqlQuery
            };
            
            console.log('Stored SQL query with ID:', sqlId);
            console.log('Query:', sqlQuery);
            return sqlId;
        }

        // Modified addMessageHistory to support SQL queries from server
        function addMessageHistory(text, type, time, sqlQuery = null, visualisasi = null) {
            const chatArea = document.getElementById('chatArea');
            const emptyState = document.getElementById('emptyState');

            if (messageCount === 0 && emptyState) emptyState.style.display = 'none';

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            // --- ðŸ§  Chart visualization logic (copied & adapted from addMessage)
            let chartHtml = '';
            let chartId = null;

            if (visualisasi) {
                // Normalize if string
                if (typeof visualisasi === 'string') {
                    try { visualisasi = JSON.parse(visualisasi); }
                    catch (err) { console.error('Invalid visualisasi JSON:', err); visualisasi = null; }
                }

                if (visualisasi && Array.isArray(visualisasi.data) && visualisasi.data.length > 0) {
                    chartId = 'chart_' + Date.now() + '_' + Math.floor(Math.random() * 1000);

                    const labels = visualisasi.data.map(item => String(item[visualisasi.xKey] ?? ''));

                    let chartPayload;
                    if (Array.isArray(visualisasi.yKey)) {
                        const datasets = visualisasi.yKey.map(key => ({
                            label: key,
                            data: visualisasi.data.map(item => parseNumericValue(item[key]))
                        }));
                        chartPayload = {
                            labels,
                            datasets,
                            title: visualisasi.title || visualisasi.yKey.join(', ')
                        };
                    } else {
                        const dataSeries = visualisasi.data.map(item => parseNumericValue(item[visualisasi.yKey]));
                        chartPayload = {
                            labels,
                            data: dataSeries,
                            title: visualisasi.title || visualisasi.yKey || 'Data'
                        };
                    }

                    chartDataStorage[chartId] = chartPayload;

                    const chartIcons = {
                        bar: 'fa-chart-bar',
                        line: 'fa-chart-line',
                        pie: 'fa-chart-pie',
                        doughnut: 'fa-circle-half-stroke',
                        radar: 'fa-circle-nodes',
                        polarArea: 'fa-bullseye',
                        scatter: 'fa-braille',
                        bubble: 'fa-circle-dot',
                        mixed: 'fa-layer-group'
                    };

                    const chartTypes = ['bar', 'line', 'pie', 'doughnut', 'radar', 'polarArea', 'scatter', 'bubble'];

                    chartHtml = `
                        <div class="chart-controls">
                            <label><i class="fas fa-chart-bar"></i> Pilih Visualisasi:</label>
                            ${chartTypes.map(t => `
                                <button class="chart-type-btn ${t === (chartConfig?.chartType || 'bar') ? 'active' : ''}"
                                        data-type="${t}" onclick="changeChartType('${chartId}', '${t}')">
                                    <i class="fas ${chartIcons[t]}"></i>
                                    ${t.charAt(0).toUpperCase() + t.slice(1)}
                                </button>
                            `).join('')}
                            <button class="download-btn" onclick="downloadChart('${chartId}')">
                            <i class="fas fa-download"></i> Download PNG
                            </button>
                        </div>
                        <div class="chart-container">
                                        <canvas id="${chartId}"></canvas>
                        </div>

                    `;

                }
            }

            // --- ðŸ§± SQL query bubble (kept from your original)
            let sqlBubble = '';
            if (sqlQuery && sqlQuery.trim() !== '') {
                const sqlId = storeSqlQuery(sqlQuery);
                if (sqlId) {
                    sqlBubble = `
                        <div class="sql-query-bubble" onclick="showSqlModal('${sqlId}')">
                            <i class="fas fa-code"></i>
                        </div>
                    `;
                }
            }

            // --- ðŸ’¬ Message bubble structure
            messageDiv.innerHTML = `
                <div class="message-bubble" style="overflow-x:auto; width:100%; display:flex; flex-direction:column; align-items:flex-start;">
                    <div class="bubble-text" style="align-self:stretch;">
                        ${text}
                        ${chartHtml}
                    </div>
                    <div class="sql-bubble-wrapper" style="align-self:flex-end; margin-top:0.5rem;">
                        ${sqlBubble}
                    </div>
                </div>
                <div class="message-time">${time}</div>
            `;

            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            messageCount++;

            // --- ðŸŽ¨ Create chart after DOM render
            if (chartId && chartDataStorage[chartId]) {
                setTimeout(() => {
                    const initialChartType = (visualisasi && visualisasi.chartType) ? visualisasi.chartType : 'bar';
                    createChart(chartId, chartDataStorage[chartId], initialChartType);
                    console.log('Restored chart', chartId, chartDataStorage[chartId]);
                }, 150);
            }
        }


        // Mengambil data yang sudah di-render dari Flask ke dalam JavaScript
        let chatHis = {{ hisChat | tojson }};
        console.log('Chat History:', chatHis);

        // Memeriksa apakah chatHis ada dan merupakan array yang valid
        if (chatHis && Array.isArray(chatHis) && chatHis.length > 0) {
            // Menggunakan reverse untuk menampilkan data dari yang terakhir
            chatHis.reverse().forEach(chat => {
                // Pastikan format waktu sudah benar (misal "HH:MM:SS")
                addMessageHistory(`${chat.question}`, 'user', `${chat.time}`);
                // Pass SQL query dari server untuk system message
                const sqlQuery = chat.query || null;
                addMessageHistory(`${chat.respons}`, 'system', `${chat.time}`, sqlQuery, `${chat.visualisasi}`); // Pass visualisasi
            });
            hideTyping();  // Menyembunyikan indikator mengetik setelah chat diproses
        } else {
            console.log("No chat history available or invalid format.");
            hideTyping();  // Menyembunyikan indikator mengetik jika tidak ada riwayat chat
        }

        
        function extractTableData(tableHtml) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(tableHtml, 'text/html');
            const table = doc.querySelector('table');
            
            if (!table) return null;
            
            const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
                return Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
            });
            
            return { headers, rows };
        }

        // Parse numeric value (handle Rp. format)
        function parseNumericValue(value) {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string') return 0;
            
            // Remove Rp., dots, and commas
            const cleaned = value.replace(/Rp\.?\s*/g, '').replace(/\./g, '').replace(/,/g, '.');
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        }

        // Format number to Indonesian format
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function createChart(canvasId, chartData, chartType = 'bar') {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;

            // pastikan container punya ukuran (CSS akan mengatur height)
            canvas.style.width = '100%';

            const ctx = canvas.getContext('2d');

            // Destroy previous instance
            if (chartInstances[canvasId]) {
                try { chartInstances[canvasId].destroy(); } 
                catch (e) { console.warn('Error destroying chart:', canvasId, e); }
                delete chartInstances[canvasId];
            }

            // Build datasets
            let datasets = [];
            if (Array.isArray(chartData.datasets) && chartData.datasets.length > 0) {
                datasets = chartData.datasets.map((ds, idx) => {
                    const parsedData = Array.isArray(ds.data) ? ds.data.map(v => parseNumericValue(v)) : [];
                    if (chartType === 'pie' || chartType === 'doughnut') {
                        return {
                            label: ds.label || `Series ${idx+1}`,
                            data: parsedData,
                            backgroundColor: generateColors(parsedData.length),
                            borderColor: parsedData.map(() => getColor(idx).replace(/0\.8\)$/, '1)')),
                            borderWidth: 1
                        };
                    }
                    return {
                        label: ds.label || `Series ${idx+1}`,
                        data: parsedData,
                        backgroundColor: getColor(idx),
                        borderColor: getColor(idx).replace(/0\.8\)$/, '1)'),
                        borderWidth: 2
                    };
                });
            } else {
                // single-series support (chartData.data)
                const singleData = Array.isArray(chartData.data) ? chartData.data.map(v => parseNumericValue(v)) : [];
                datasets = [{
                    label: chartData.title || 'Data',
                    data: singleData,
                    backgroundColor: (chartType === 'pie' || chartType === 'doughnut') ? generateColors(singleData.length) : 'rgba(102, 126, 234, 0.8)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2
                }];
            }

            const config = {
                type: chartType,
                data: {
                    labels: chartData.labels || [],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // respect CSS height
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    const val = (context.parsed && typeof context.parsed === 'object') ? (context.parsed.y ?? context.parsed) : context.parsed;
                                    label += 'Rp. ' + formatNumber(Number(val || 0));
                                    return label;
                                }
                            }
                        }
                    },
                    scales: (chartType !== 'pie' && chartType !== 'doughnut') ? {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 30,
                                callback: function(value, index) {
                                    const label = this.getLabelForValue(value);
                                    return label && label.length > 25 ? label.slice(0, 25) + 'â€¦' : label;
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp. ' + formatNumber(value);
                                }
                            }
                        }
                    } : {}
                }
            };

            const chart = new Chart(ctx, config);
            chartInstances[canvasId] = chart;
            return chart;
        }


        function getColor(idx) {
        const palette = [
            'rgba(0, 135, 68, 0.85)',   // deep green
            'rgba(34, 170, 93, 0.85)',  // bright green
            'rgba(0, 153, 204, 0.85)',  // blue-cyan
            'rgba(32, 126, 202, 0.85)', // deep blue
            'rgba(14, 102, 185, 0.85)', // dark blue
            'rgba(102, 204, 153, 0.85)',// light green
            'rgba(0, 102, 153, 0.85)',  // ocean blue
            'rgba(0, 180, 135, 0.85)'   // teal
        ];
        return palette[idx % palette.length];
        }

        function generateColors(count) {
        const palette = [
            'rgba(0, 135, 68, 0.85)',
            'rgba(34, 170, 93, 0.85)',
            'rgba(0, 153, 204, 0.85)',
            'rgba(32, 126, 202, 0.85)',
            'rgba(14, 102, 185, 0.85)',
            'rgba(102, 204, 153, 0.85)',
            'rgba(0, 102, 153, 0.85)',
            'rgba(0, 180, 135, 0.85)'
        ];
        const result = [];
        for (let i = 0; i < count; i++) {
            result.push(palette[i % palette.length]);
        }
        return result;
        }



        // Change chart type
        function changeChartType(chartId, newType) {
            if (!chartDataStorage[chartId]) return;
            
            const chartData = chartDataStorage[chartId];
            createChart(chartId, chartData, newType);
            
            // Update active button
            const container = document.getElementById(chartId).closest('.message-bubble');
            const buttons = container.querySelectorAll('.chart-type-btn');
            buttons.forEach(btn => {
                if (btn.dataset.type === newType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function addMessage(text, type, sqlQuery = null, chartConfig = null) {
            const chatArea = document.getElementById('chatArea');
            const emptyState = document.getElementById('emptyState');

            if (messageCount === 0 && emptyState) emptyState.style.display = 'none';

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            let chartHtml = '';
            let chartId = null;

            // Normalize chartConfig if string
            if (chartConfig) {
                if (typeof chartConfig === 'string') {
                    try { chartConfig = JSON.parse(chartConfig); }
                    catch (err) { console.error('Invalid chartConfig JSON:', err); chartConfig = null; }
                }
            }

            // Build chart payload only if valid
            if (chartConfig && Array.isArray(chartConfig.data) && chartConfig.data.length > 0) {
                chartId = 'chart_' + Date.now();

                const labels = chartConfig.data.map(item => String(item[chartConfig.xKey] ?? ''));

                let chartPayload;
                if (Array.isArray(chartConfig.yKey)) {
                    const yKeys = chartConfig.yKey;
                    const datasets = yKeys.map((key, idx) => ({
                        label: key,
                        data: chartConfig.data.map(item => parseNumericValue(item[key]))
                    }));
                    chartPayload = {
                        labels,
                        datasets,
                        title: chartConfig.title || yKeys.join(', ')
                    };
                } else {
                    const dataSeries = chartConfig.data.map(item => parseNumericValue(item[chartConfig.yKey]));
                    chartPayload = {
                        labels,
                        data: dataSeries,
                        title: chartConfig.title || chartConfig.yKey || 'Data'
                    };
                }

                chartDataStorage[chartId] = chartPayload;
                const chartIcons = {
                    bar: 'fa-chart-bar',
                    line: 'fa-chart-line',
                    pie: 'fa-chart-pie',
                    doughnut: 'fa-circle-half-stroke',
                    radar: 'fa-circle-nodes',
                    polarArea: 'fa-bullseye',
                    scatter: 'fa-braille',
                    bubble: 'fa-circle-dot',
                    mixed: 'fa-layer-group'
                };

                const chartTypes = ['bar', 'line', 'pie', 'doughnut', 'radar', 'polarArea', 'scatter', 'bubble'];

                chartHtml = `
                <div class="chart-controls">
                    <label><i class="fas fa-chart-bar"></i> Pilih Visualisasi:</label>
                    ${chartTypes.map(t => `
                        <button class="chart-type-btn ${t === (chartConfig?.chartType || 'bar') ? 'active' : ''}"
                                data-type="${t}" onclick="changeChartType('${chartId}', '${t}')">
                            <i class="fas ${chartIcons[t]}"></i>
                            ${t.charAt(0).toUpperCase() + t.slice(1)}
                        </button>
                    `).join('')}
                    <button class="download-btn" onclick="downloadChart('${chartId}')">
                    <i class="fas fa-download"></i> Download PNG
                    </button>
                </div>
                <div class="chart-container">
                                        <canvas id="${chartId}"></canvas>
                        </div>
                `;

            }

            // SQL bubble (kept existing behavior)
            let sqlBubble = '';
            if (sqlQuery && typeof sqlQuery === 'string' && sqlQuery.trim() !== '') {
                const sqlId = storeSqlQuery(sqlQuery);
                if (sqlId) {
                    sqlBubble = `
                        <div class="sql-bubble-wrapper" style="width:100%; display:flex; justify-content:flex-end; margin-top:0.5rem;">
                            <div class="sql-query-bubble" onclick="showSqlModal('${sqlId}')">
                                <i class="fas fa-code"></i>
                            </div>
                        </div>
                    `;
                }
            }

            messageDiv.innerHTML = `
                <div class="message-bubble" style="overflow-x: auto; width: 100%; max-width: 100%;">
                    ${text}
                    ${chartHtml}
                    ${sqlBubble}
                </div>
                <div class="message-time">${getCurrentTime()}</div>
            `;

            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            messageCount++;

            // Create chart after DOM update
            if (chartId && chartDataStorage[chartId]) {
                setTimeout(() => {
                    const initialChartType = (chartConfig && chartConfig.chartType) ? chartConfig.chartType : 'bar';
                    createChart(chartId, chartDataStorage[chartId], initialChartType);
                    console.log('Created chart', chartId, chartDataStorage[chartId]);
                }, 150);
            }
        }

        // Show SQL modal
        function showSqlModal(sqlId) {
            const modal = document.getElementById('sqlModal');
            const modalBody = document.getElementById('sqlModalBody');
            
            if (!sqlQueriesStorage[sqlId]) {
                console.error('SQL query not found for ID:', sqlId);
                modalBody.innerHTML = '<p>Query SQL tidak ditemukan.</p>';
                modal.style.display = 'block';
                return;
            }
            
            const queryData = sqlQueriesStorage[sqlId];
            console.log('Showing SQL modal for:', queryData);

            const plain = normalizeIndent(queryData.sql);           // PLAIN TEXT (tanpa span)
            const highlighted = formatSqlCode(escapeHtml(plain));   // HTML (dengan <span>)

            modalBody.innerHTML = `
            <div class="query-info">
                <h4>${queryData.title}</h4>
                <p>${queryData.description}</p>
            </div>

            <div class="sql-code">
                <button class="copy-btn" data-target="sql-plain-${sqlId}" onclick="copyToClipboard(this)">
                <i class="fas fa-copy"></i> Copy
                </button>

                <pre class="sql-block"><code id="sql-highlight-${sqlId}">${highlighted}</code></pre>
                <!-- simpan plain text tersembunyi untuk keperluan copy -->
                <pre id="sql-plain-${sqlId}" style="display:none;">${plain}</pre>
            </div>
            `;

            modal.style.display = 'block';
        }

        function normalizeIndent(sql) {
        const lines = String(sql).replace(/\t/g, '  ').replace(/\\n/g, '\n').split('\n');
        const nonEmpty = lines.filter(l => l.trim().length);
        const base = nonEmpty.length ? Math.min(...nonEmpty.map(l => (l.match(/^[ \t]*/)[0] || '').length)) : 0;
        return lines.map(l => l.slice(base)).join('\n').trim();
        }

        function escapeHtml(s) {
            return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // HIGHLIGHT: jalankan SETELAH escapeHtml
        function formatSqlCode(sql) {
            return sql
                .replace(/\b(SELECT|FROM|WHERE|INNER JOIN|LEFT JOIN|RIGHT JOIN|GROUP BY|ORDER BY|HAVING|LIMIT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|INDEX|TABLE|DATABASE|AND|OR|NOT|IN|EXISTS|BETWEEN|LIKE|IS NULL|IS NOT NULL|DISTINCT|COUNT|SUM|AVG|MAX|MIN|DATE_FORMAT|NOW|INTERVAL|ON|AS|CASE|WHEN|THEN|ELSE|END)\b/gi, '<span class="sql-keyword">$1</span>')
                .replace(/'([^']*?)'/g, '<span class="sql-string">\'$1\'</span>')
                .replace(/--([^\n]*)/g, '<span class="sql-comment">--$1</span>')
                .replace(/\b(customer_id|nama_lengkap|email|no_telepon|alamat|tanggal_daftar|status_aktif|transaksi_id|nama_pelanggan|produk_id|jumlah_pembayaran|tanggal_transaksi)\b/g, '<span class="sql-function">$1</span>');
        }
        // Copy SQL to clipboard
        function copyToClipboard(button) {
            const plainId = button.getAttribute('data-target');
            const plainEl = document.getElementById(plainId);
            const text = plainEl ? plainEl.textContent : '';

            navigator.clipboard.writeText(text).then(() => {
                const original = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                button.innerHTML = original;
                button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }


        // Close SQL modal
        function closeSqlModal() {
            const modal = document.getElementById('sqlModal');
            modal.style.display = 'none';
        }

        // Send message function
        let waitingResponse = false;
        let isLoggedIn = {{isLogin | tojson | safe}};
        let sessionId = {{session_id | tojson | safe}};
        console.log("Session ID:", sessionId);
        console.log("Is Logged In:", isLoggedIn);

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendButton');
            const message = input.value.trim();

            // Jangan kirim pesan jika masih menunggu balasan
            if (!message || waitingResponse) return;
             // Show typing indicator when sending message    
            addMessage(message, 'user');

             // Show typing indicator
            input.value = '';
            waitingResponse = true;
            input.disabled = true;
            sendBtn.disabled = true;

            // Jika user belum login dan pesan mengandung @ (anggap email)
            if (!isLoggedIn && message.includes('@')) {
                showTyping(); // Show typing indicator before login attempt
                handleLogin(message);
                hideTyping(); // Hide typing indicator after login attempt
                return;
            } else if (message == 'logout' || message == 'Logout' || message == 'LOGOUT' || message == 'Keluar' || message == 'keluar') {
               if (!isLoggedIn){
                    addMessage("Anda belum login", 'system');
                    resetInput(input, sendBtn);
                    return;
               } // Handle logout
                fetch('/logout')
                    .then(response => response.json())
                    .then(data => {
                        isLoggedIn = false;
                        sessionId = null;
                        addMessage("Anda telah berhasil logout.", 'system');
                        resetInput(input, sendBtn);
                        return;
                    })
                    .catch(error => {
                        console.error('Logout error:', error);
                        addMessage("Terjadi kesalahan saat logout. Coba lagi.", 'system');
                        resetInput(input, sendBtn);
                        return;
                    })
                    .finally(() => hideTyping()); // Hide typing indicator after logout
                return;
            } else if (message == "reset" || message == "Reset" || message == "RESET") {
                fetch('/reset', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if (response.ok) {
                        console.log("Session reset successful.");
                        window.location.href = '/';  // Sesuaikan URL sesuai aplikasi kamu
                    } else {
                        console.error('Failed to reset session.');
                    }
                })
                .catch(error => {
                    console.error('Error during session reset:', error);
                })
                .finally(() => hideTyping()); // Hide typing indicator after reset
                return;
            } else if (message == 'help' || message == 'Help' || message == 'HELP') {
                addMessage("Ketikkan email anda untuk login, atau ketik 'logout' untuk keluar. Dan ketik reset jika ingin menghapus chat", 'system');
                resetInput(input, sendBtn);
                hideTyping();
                return;
            } else if (message == 'clear' || message == 'Clear' || message == 'CLEAR') {
                document.getElementById('chatArea').innerHTML = '';
                emptyState.style.display = 'block';
                resetInput(input, sendBtn);
                hideTyping();
                return;
            }

            if (isLoggedIn) {
                showTyping(); // Show typing indicator before asking
                handleAsk(message); // Ask if already logged in
                hideTyping(); // Hide typing indicator after ask
            } else {
                addMessage("Silakan masukkan email untuk login terlebih dahulu.", 'system');
                resetInput(input, sendBtn);
                hideTyping();
            }
            console.log("Bawah")
        }

        // Fungsi untuk menangani login
        function handleLogin(email) {
            hideTyping();
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendButton');
            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.answer) {
                    sessionId = data.answer;
                    isLoggedIn = true;
                    window.location.href = '/';
                    addMessage(`Halo selamat datang, ${sessionId}. Ada yang bisa kami bantu?`, 'system');
                    if (data.hisChat && data.hisChat.length > 0) {
                        data.hisChat.reverse().forEach(chat => {
                            // Menambahkan question dan respons ke dalam chat
                            addMessageHistory(`${chat.question}`, 'user', `${chat.time}`);
                            // Pass SQL query dari server untuk system message
                            const sqlQuery = chat.query || null;
                            addMessageHistory(`${chat.respons}`, 'system', `${chat.time}`, sqlQuery);
                        });
                        hideTyping(); 
                    }
                    hideTyping(); // Hide typing indicator after login
                } else if (data.error) {
                    addMessage(data.error, 'system');
                    hideTyping();
                }
                hideTyping(); // Hide typing indicator after login attempt
            })
            .catch(error => {
                console.error('Login error:', error);
                addMessage("Terjadi kesalahan saat login. Coba lagi.", 'system');
            })
            .finally(() => resetInput(input, sendBtn)); hideTyping(); // Always reset input after login attempt
        }

        // Modified handleAsk function to handle SQL queries from server
        function handleAsk(message) {
            hideTyping();
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendButton');
            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: message, session_id: sessionId })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Backend response:', data);
                
                // Get SQL query from server response
                const sqlQuery = data.query || null;
                
                // Get chartConfig from server response - INI YANG BARU!
                const chartConfig = data.chartConfig || null;
                
                console.log('Received SQL query from server:', sqlQuery);
                console.log('Received chartConfig from server:', chartConfig);
                
                // Add message dengan SQL query dan chartConfig jika ada - GANTI FUNGSI!
                addMessage(data.answer, 'system', sqlQuery, chartConfig);
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage("Terjadi kesalahan. Coba lagi.", 'system');
            })
            .finally(() => resetInput(input, sendBtn)); hideTyping();
        }

        function resetInput(input, sendBtn) {
            waitingResponse = false;
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
            hideTyping(); // Hide typing indicator when done
        }

        function downloadChart(chartId) {
            const canvas = document.getElementById(chartId);
            if (!canvas) return;

            const image = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = image;
            link.download = `${chartId}.png`;
            link.click();
        }

        // Enter key to send
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('sqlModal');
            if (event.target === modal) {
                closeSqlModal();
            }
        }

        // Focus input on load
        window.addEventListener('load', function() {
            document.getElementById('messageInput').focus();
        });

        setInterval(isLoggedIn, sessionId, 5000)
        
    </script>
</body>
</html>